# Plan to Fix Top 10 Incomplete Pod Tests

**Total Blocked Tests: 175 tests across 10 files**

## Issue Categories and Action Plan

### Category 1: Parser Error - `grep BLOCK HASH_DEREF` (48 tests blocked)
**Affected Files:**
- Pod::Simple::search22.t (13 tests blocked)
- Pod::Simple::htmlbat.t (13 tests blocked)  
- Pod::Simple::search10.t (9 tests blocked)

**Root Cause:**
All three files fail with the same parse error in `Pod::Simple::Search.pm` line 141/145:
```perl
$files_for = sub { my $n = lc $_[0]; grep { lc $path2name->{$_} eq $n } %{ $path2name } };
```

Error: `Expected token OPERATOR with text , but got LexerToken{type=OPERATOR, text='}'}`

**Problem:** 
The parser sees `} %{` and interprets the first `}` as the end of the grep block, then expects a comma but encounters another `}` from the hash dereference `%{ $path2name }`.

**Fix Strategy:**
1. Investigate `ParseInfix.java` or `ParsePrimary.java` - how does the parser handle `grep BLOCK LIST`?
2. The issue is distinguishing between:
   - `grep { ... }` (end of block) followed by a list
   - `grep { ... } %{ ... }` where `%{ }` is a hash dereference (not end of block)
3. After parsing the closing `}` of a grep/map block, check if next token is `%{` or `@{` (dereferencing)
4. If yes, continue parsing the list expression instead of expecting comma

**Implementation:**
- File: `src/main/java/org/perlonjava/parser/ParsePrimary.java` (or wherever grep is parsed)
- Look for `case "grep":` or `case "map":`
- After parsing the block, add logic to handle hash/array dereferencing as the start of the list
- May need to modify the tokenizer to not break `} %{` into separate statements

**Test Verification:**
```perl
# Minimal test case
my %hash = (a => 1, b => 2);
my @result = grep { $_ > 0 } %{ \%hash };  # Should parse correctly
```

**Priority:** HIGH - Blocks 48 tests in 3 files

---

### Category 2: JVM VerifyError - Bad Local Variable Type (39 tests blocked)
**Affected Files:**
- Pod::Simple::output.t (24 tests blocked after test 12)
- Pod::Simple::html01.t (15 tests blocked at start)

**Root Cause:**
```
java.lang.VerifyError: Bad local variable type
Type top (current frame, locals[34]) is not assignable to reference type
```

**Problem:**
This is a bytecode generation error where a local variable slot is marked as `top` (uninitialized/invalid) but the code tries to use it as a reference type. This is similar to the hash.t issue we fixed with prototype handling.

**Analysis Needed:**
1. The error occurs in dynamically generated anonymous subroutines (`org/perlonjava/anon562`, `org/perlonjava/anon723`)
2. Local variable at slot 34 is marked as `top` but code expects a reference
3. This suggests incorrect local variable table management in the emitter

**Fix Strategy:**
1. Run the failing test with `--disassemble` to see generated bytecode
2. Identify which Perl construct triggers the bad bytecode (likely complex closures or nested subs)
3. Check `EmitVariable.java` and `EmitSubroutine.java` for local variable allocation
4. Ensure all code paths properly initialize or clear local variable slots
5. May need to add explicit null initialization for reference-type locals

**Investigation Steps:**
```bash
# Get the actual failing code
./jperl --disassemble src/test/resources/Pod/Pod-Simple/output.t > /tmp/output_disasm.txt 2>&1
# Look for anon723 or the failing method
# Identify the Perl code that generates slot 34
```

**Likely Culprit:**
- Nested closures with many captured variables
- Complex anonymous subroutines in Pod::Simple modules
- Variable reuse or scope handling in nested blocks

**Priority:** HIGH - Blocks 39 tests in 2 files, similar to previous bytecode issues

---

### Category 3: Missing Test Data Files (41 tests blocked)
**Affected Files:**
- Pod::podlators::man::iso-8859-1.t (17 tests blocked)
- Pod::podlators::man::utf8-io.t (15 tests blocked)
- Pod::podlators::general::basic.t (9 tests blocked)

**Root Cause:**
Test data files missing from filesystem:
- `t/data/snippets/man/iso-8859-1-roff`
- `t/data/snippets/man/utf8-nonbreaking`
- `t/data/basic.pod`

**Fix Strategy:**
1. Check if these files exist in perl5 repository
2. Copy test data files to appropriate locations:
   ```bash
   mkdir -p t/data/snippets/man/
   mkdir -p t/data/
   ```
3. May need to import from perl5 test suite or create minimal test data

**Investigation:**
```bash
# Check perl5 repository
git clone https://github.com/Perl/perl5.git /tmp/perl5
find /tmp/perl5 -name "iso-8859-1-roff" -o -name "utf8-nonbreaking" -o -name "basic.pod"
```

**Alternative:**
If files don't exist in perl5, check podlators distribution:
```bash
# Check CPAN podlators
# https://metacpan.org/release/podlators
```

**Priority:** MEDIUM - Easy fix once files are located, blocks 41 tests

---

### Category 4: Missing Perl Modules (25 tests partially blocked)
**Affected Files:**
- Pod::podlators::text::termcap.t (16 tests blocked)
- Pod::podlators::general::basic.t (additional blockage)

**Root Cause:**
Missing Java implementations of Perl modules:
1. **POSIX module** - `Can't load 'org.perlonjava.perlmodule.POSIX'`
2. **Term::ANSIColor** - `Can't locate Term/ANSIColor.pm`

**Fix Strategy:**

#### 4a. POSIX Module
```java
// Create: src/main/java/org/perlonjava/perlmodule/POSIX.java
public class POSIX {
    // Implement commonly used POSIX functions
    // Priority: isatty(), strerror(), localeconv()
}
```

```perl
# Create: src/main/perl/lib/POSIX.pm
package POSIX;
our $VERSION = '1.00';
# XSLoader stub
sub bootstrap { }
1;
```

#### 4b. Term::ANSIColor Module
Option 1: Import from CPAN
```bash
# Download Term::ANSIColor from CPAN
# Place in: src/main/perl/lib/Term/ANSIColor.pm
```

Option 2: Create stub implementation
```perl
# Minimal stub that Pod::Text::Color can use
package Term::ANSIColor;
our $VERSION = '5.01';
sub colored { return $_[1]; }  # Return text without color codes
sub color { return ''; }
1;
```

**Priority:** MEDIUM - Required for some Pod formatters, but tests can partially run

---

### Category 5: Minor Test Output Mismatches (44 tests partially working)
**Affected Files:**
- Pod::Simple::fcodes_s.t (34/78 tests run, 10 fail on output format)

**Root Cause:**
Test 15 fails with output mismatch:
```
got:      '    http://www.perl.com <http://www.perl.com>\n'
expected: '    http://www.perl.com\n'
```

**Problem:**
Pod formatting adds URL in angle brackets when it shouldn't, or fails to strip them.

**Fix Strategy:**
1. This is in Pod::Simple formatting logic, not PerlOnJava core
2. Check `Pod::Simple` module for URL formatting in links
3. Likely in `Pod::Simple::Text` or similar formatter
4. May be related to `L<>` link handling

**Investigation:**
```perl
# Test case
use Pod::Simple::Text;
my $parser = Pod::Simple::Text->new();
# Test with L<http://www.perl.com> formatting
```

**Priority:** LOW - Tests mostly work, just output format differences

---

## Execution Order (Priority)

### Phase 1: Parser Fixes (HIGH IMPACT)
1. **Fix `grep BLOCK HASH_DEREF` parsing** (Category 1) → +48 tests
   - Estimated effort: 2-4 hours
   - Files to modify: `ParsePrimary.java` or `ParseInfix.java`

2. **Fix VerifyError bytecode generation** (Category 2) → +39 tests
   - Estimated effort: 4-8 hours (requires bytecode analysis)
   - Files to modify: `EmitVariable.java`, `EmitSubroutine.java`

### Phase 2: Infrastructure (QUICK WINS)
3. **Add missing test data files** (Category 3) → +41 tests
   - Estimated effort: 1-2 hours (mostly copying files)
   - Just file operations, no code changes

### Phase 3: Module Implementation (MEDIUM IMPACT)
4. **Implement POSIX and Term::ANSIColor stubs** (Category 4) → +25 tests
   - Estimated effort: 2-3 hours
   - Create minimal stubs for Pod formatters

### Phase 4: Polish (LOW PRIORITY)
5. **Fix Pod formatting output** (Category 5) → +10 tests
   - Estimated effort: 2-4 hours
   - Fine-tuning Pod::Simple output

---

## Expected Results

**After Phase 1:** ~87 tests unblocked (50% of blocked tests)
**After Phase 2:** ~128 tests unblocked (73% of blocked tests)
**After Phase 3:** ~153 tests unblocked (87% of blocked tests)
**After Phase 4:** ~163 tests unblocked (93% of blocked tests)

**Total recovery:** 163 out of 175 blocked tests

---

## Risk Assessment

**High Risk:**
- Category 2 (VerifyError): May require deep JVM bytecode expertise
- Category 1 (Parser): Could affect other constructs using blocks

**Medium Risk:**
- Category 4 (POSIX): Partial implementation may cause issues
- Category 3 (Test files): May need extensive test data

**Low Risk:**
- Category 5 (Output format): Cosmetic, doesn't affect functionality

---

## Testing Strategy

After each fix:
1. Run the affected test files
2. Run full Pod test suite to check for regressions
3. Compare before/after with `compare_test_logs.pl`
4. Verify no new bytecode errors with `--disassemble`

---

## Notes

- The parser fix (Category 1) should be attempted first as it's clean and well-defined
- The VerifyError (Category 2) may be similar to the hash.t issue we fixed earlier
- Categories 3 and 4 are infrastructure work that doesn't require complex code changes
- Category 5 can be deferred as tests are mostly functional

**DO NOT EXECUTE YET** - This is the analysis and plan only.

